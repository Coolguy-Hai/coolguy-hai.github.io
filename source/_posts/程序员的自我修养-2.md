---
title: 《程序员的自我修养》第二章 编译与链接
date: 2021-07-02 09:47:11
tags: 读书笔记
---

## 被隐藏的过程

编译一个程序时通常经过4个步骤：预处理、编译、汇编、链接。

#### 1. 预处理

预处理过程主要处理那些源代码文件中以`#`开头的语句。

- 删除`#define`语句，展开宏定义。
- 处理条件预编译语句，`#if`、`#elif`等。
- 删除所有注释。
- 添加行号和文件名标识，以便在显示错误信息时能提供位置信息。
- 保留`#pragma`编译器指令。

#### 2. 编译

编译过程就是把处理后的文件进行一系列的词法分析、语法分析、语义分析以及生产优化相应的汇编代码文件。

#### 3. 汇编

汇编即将汇编代码转换成机器可以执行的指令。

#### 4. 链接

## 编译器做了什么

#### 1. 词法分析

利用有限状态机将源代码分割成一系列的记号。

#### 2. 语法分析

对由词法分析产生的记号进行语法分析，从而产生语法树，判断是否具有语法错误。

#### 3. 语义分析

分析语句是否具有意义，编译器所能分析的仅有静态语义，与之相对的动态语义仅有在运行期间可以确定。

静态语义通常包括声明和类型的匹配，类型的转换。动态语义一般指在运行期出现的语义相关的问题，比如将0作为除数是一个运行期语义错误。

#### 4. 中间语言生成

源代码往往能被优化器优化，例如`(2+6)`这个表达式就可以优化掉，因为它的值在编译期就可以确定。而直接在语法树上进行优化并不容易，因此往往转换成中间代码进行优化。中间代码有许多的形式，常见的有三地址码和P-代码。最基本的三地址码如下：

```
x = y op z
```

```c
array[index] = (index + 4) * (2 + 6);
```

以上代码转换为三地址码后如下所示：

```c
t1 = 2 + 6
t2 = index + 4
t3 = t2 * t1
array[index] = t3
```

经过优化后的代码如下所示：

```c
t2 = index + 4
t2 = t2 * 8
array[index] = t2
```

中间代码使得编译器可以被分为前端和后端。前端负责产生机器无关的中间代码，后端将中间代码转换成目标机器代码。

#### 5. 目标代码生成与优化

编译器后端主要包括代码生成器和目标代码优化器。代码生成器将中间代码转换成目标机器代码，这个过程依赖于目标机器，因为不同的机器有着不同的字长、寄存器和整数数据类型等。

随后目标代码优化器对上述的目标代码进行优化，比如选择合适的寻址方式、使用位移代替乘法运算、删除多余的指令等。

## 链接器年龄比编译器长

